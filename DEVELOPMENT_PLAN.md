# DifyModel 开发方案（分步实施）

## 1. 目标
- 建设一个生产级、可扩展的 AI 编排平台（非单一搜题项目）。
- 首阶段落地搜题场景，后续可复用到文档问答、运营助手、规则判断等。
- 在准确率、时延、成本三者间建立可治理机制。

## 2. 实施原则
- 平台先行：先做统一接入与协议，不直接耦合某个场景。
- 配置驱动：新增场景通过配置+工作流，不重写核心代码。
- 可灰度可回滚：任何关键能力都支持渐进发布。
- 可观测可评估：上线前后都可量化判断效果。

---

## 3. 阶段拆解与交付

## Phase 0：项目基线与工程规范（Day 1）
### 开发内容
1. 初始化项目目录结构：`docs/`、`configs/`、`src/`、`tests/`、`ops/`。
2. 建立环境配置模板：`dev/staging/prod`。
3. 约定代码规范、日志规范、分支策略、提交规范。

### 交付物
- 项目基础结构。
- `README.md`、环境变量模板。
- 开发规范文档。

### 验收标准
- 新人可在 30 分钟内完成本地启动（基础服务）。

---

## Phase 1：统一协议与场景模型（Day 2-3）
### 开发内容
1. 定义统一 API：
   - `POST /v1/infer`
   - `GET /v1/infer/stream/:trace_id`
   - `POST /v1/feedback`
2. 定义通用场景模型字段：
   - `scenario_id`
   - `input_schema`
   - `workflow_binding`
   - `knowledge_policy`
   - `quality_policy`
   - `latency_budget`
   - `output_schema`
3. 定义统一输出结构（所有场景一致）。

### 交付物
- `docs/API_SPEC.md`
- `docs/SCENARIO_SCHEMA.md`

### 验收标准
- 契约冻结，可供上游/下游并行开发。

---

## Phase 2：平台骨架开发（Day 4-6）
### 开发内容
1. 接入层（Gateway）：鉴权、限流、参数校验、trace_id。
2. 路由层（Scenario Router）：按 `scenario_id` 路由。
3. 策略层（Policy Engine）：时延预算、重试、降级策略。
4. 流式返回链路（SSE）打通。

### 交付物
- 可运行平台骨架（可用 mock 响应验证流程）。

### 验收标准
- 请求可完成全链路流转，trace_id 全程可追踪。

---

## Phase 3：Dify 接入层（Day 7-9）
### 开发内容
1. Dify Connector：
   - Workflow 调用
   - 流式结果适配
   - 超时、重试、错误映射
2. 结果标准化（Normalizer）：Dify 原始输出 -> 平台统一输出。
3. Provider Adapter 抽象：预留非 Dify 扩展能力。

### 交付物
- Dify 端到端可调用能力。

### 验收标准
- 输入请求可稳定得到标准化结果。
- 上游不需要感知 Dify 细节。

---

## Phase 4：搜题 MVP 场景落地（Day 10-14）
### 开发内容
1. 实现 `exam_qa` 场景配置。
2. 题型子路由：图推/逻辑/言语/资料/常识。
3. 每个子题型绑定独立 workflow。
4. 质量策略：快速首答 + 低置信度补强。
5. 知识库策略：仅对适合题型启用检索。

### 交付物
- 搜题 MVP 可用版本（接入统一 API）。

### 验收标准
- 达到预设的 MVP 指标（准确率、P95 时延、错误率）。

---

## Phase 5：知识库治理体系（Week 3）
### 开发内容
1. 知识库元数据管理：域、版本、来源、状态。
2. 场景-知识库映射配置化。
3. 检索日志可追踪（命中片段、得分、`kb_version`）。
4. 知识库发布流程（灰度/回滚）。

### 交付物
- 知识库治理文档与配置体系。

### 验收标准
- 任一请求可回溯：命中哪个知识库、哪个版本、哪些片段。

---

## Phase 6：质量评测与反馈闭环（Week 3）
### 开发内容
1. 构建离线评测集（按题型分层）。
2. 评测任务：批量回放、自动评分、报告输出。
3. 接入反馈机制（正确/错误/部分正确）。
4. 设发布门禁：评测不达标禁止上线。

### 交付物
- `docs/EVAL_PLAN.md`
- 评测报告模板与执行流程。

### 验收标准
- 每次变更有可量化评估结果，支持版本对比。

---

## Phase 7：可观测与运维体系（Week 4）
### 开发内容
1. 指标：QPS、P50/P95、错误率、超时率、成本。
2. 日志：结构化日志 + trace_id。
3. 告警：调用失败率、时延突增、成本异常。
4. 运行手册：故障定位、降级、回滚流程。

### 交付物
- 监控看板、告警规则、`ops/RUNBOOK.md`。

### 验收标准
- 线上异常可快速定位并执行标准化处置。

---

## Phase 8：与现有系统集成与灰度（Week 4）
### 开发内容
1. 在旧系统新增 Provider 开关（老链路 / DifyModel）。
2. 按流量比例灰度（10% -> 30% -> 100%）。
3. 灰度期间持续观察准确率、时延、成本。
4. 保留快速回滚开关。

### 交付物
- 集成说明文档与灰度记录。

### 验收标准
- 全量切换后稳定，且支持秒级回退。

---

## 4. 里程碑
- M1（第 1 周末）：平台骨架 + Dify 调通。
- M2（第 2 周末）：搜题 MVP 可用。
- M3（第 3 周末）：评测与知识库治理上线。
- M4（第 4 周末）：灰度完成，具备生产切换条件。

---

## 5. 角色与分工建议
- 后端工程：API/Gateway、Router、Policy、Connector、日志追踪。
- AI/策略工程：场景策略、题型路由、工作流与质量门控。
- 数据/知识库工程：KB 构建、版本治理、检索优化。
- 测试工程：接口回归、评测任务、灰度验证。
- 运维工程：监控、告警、部署、容灾与回滚。

---

## 6. 风险与应对
- Dify 单点依赖风险：保留 Provider Adapter，避免接口被锁死。
- 准确率提升但时延恶化：强制时延预算与降级策略。
- 知识库引入噪声：分场景启用，先离线评测再上线。
- 场景扩展后配置膨胀：配置模板化 + 变更审计流程。

---

## 7. 上线前 Go/No-Go 检查（必须满足）
1. 契约稳定：API 字段冻结并完成联调。
2. 评测达标：准确率、P95、错误率达到阈值。
3. 可观测就绪：日志/指标/告警全部可用。
4. 回滚可用：开关和旧链路验证通过。
5. 安全合规：密钥管理、权限控制、审计日志生效。

---

## 8. 下一步执行建议
1. 先完成 Phase 0-2，确保平台骨架与协议稳定。
2. 并行推进 Phase 3（Dify 接入）与 Phase 4（搜题 MVP）。
3. MVP 可用后立即补齐 Phase 5-7，避免“能跑但不可运营”。
4. 最后做 Phase 8 灰度切流，稳定后再扩展第二场景。


# DifyModel 通用智能编排平台方案（不含代码）

## 1. 背景与目标

### 1.1 背景
当前你已准备把“搜题”能力从既有客户端中抽离，改为独立的 Dify 编排能力中心。为了避免未来只服务单一场景（搜题），本方案按“通用 AI 业务中台”设计：同一套平台可支持搜题、文档问答、运营助手、规则判断、内容生成、流程自动化等。

### 1.2 建设目标
- 把业务侧与模型/知识库细节解耦，形成可复用 AI 能力层。
- 支持多场景扩展：新增场景不改底层架构，只新增场景配置和工作流。
- 支持多模型与多知识库路由，按成本、时延、准确率动态选择。
- 提供可观测、可评估、可回归的运营体系（而非一次性 demo）。
- 对上游系统保持稳定 API 契约，保障平滑迁移与回滚。

### 1.3 非目标（当前阶段）
- 不在本阶段做复杂训练/微调平台。
- 不在本阶段做跨云多活部署。
- 不在本阶段做全链路自动标注闭环（先人工+半自动）。

---

## 2. 设计原则

- **场景解耦**：场景逻辑通过配置驱动，不写死在核心代码中。
- **供应商无关**：Dify 是当前编排引擎，但平台接口不绑定 Dify 单点。
- **质量与时延平衡**：优先“足够快 + 可用正确”，再按置信度补强。
- **可回放可追责**：请求、检索片段、模型输出、后处理结果均可追溯。
- **渐进式演进**：先支持核心场景，再迭代治理能力（评测、灰度、AB）。

---

## 3. 总体架构（逻辑）

### 3.1 分层
1. **接入层（Gateway/API）**
   - 统一接收外部请求（HTTP/SSE/Webhook）。
   - 做鉴权、限流、幂等、参数校验、租户隔离。
2. **编排层（Orchestration）**
   - 场景识别、策略决策、流程编排、重试与降级。
   - 调用 Dify Workflow / Chatflow。
3. **知识层（Knowledge/RAG）**
   - 知识库管理、索引策略、召回与重排。
   - 题型/场景绑定不同知识源。
4. **能力层（Model & Tools Adapter）**
   - 模型路由（快/准/便宜）、OCR、结构化解析、规则引擎。
5. **治理层（Ops & Quality）**
   - 观测、评测、AB、告警、审计、成本控制。

### 3.2 核心组件
- `API Gateway`：统一入口。
- `Scenario Router`：判断请求属于哪类业务场景。
- `Policy Engine`：决定是否用知识库、用哪个工作流、预算多少时延/Token。
- `Dify Connector`：封装 Dify API（Workflow 触发、流式结果、状态查询）。
- `Knowledge Manager`：管理 KB 元数据与检索策略。
- `Result Normalizer`：把 Dify 原始输出映射为统一结果协议。
- `Feedback & Eval`：接收人工反馈，沉淀评测集与指标。

---

## 4. 面向通用性的“场景模型”

### 4.1 场景抽象
每个场景定义为：
- `scenario_id`：如 `exam_qa`, `doc_qa`, `ops_assistant`。
- `input_schema`：输入字段规范（文本、图片、附件、上下文）。
- `workflow_binding`：绑定 Dify 的 workflow/chatflow。
- `knowledge_policy`：是否启用知识库、召回范围、重排规则。
- `quality_policy`：置信度阈值、是否二次校验、最大重试次数。
- `latency_budget`：总时延预算与阶段预算。
- `output_schema`：标准输出字段。

### 4.2 场景配置化收益
- 新增场景主要是“加配置 + 加 Dify 流程”，不是重写服务。
- 可快速支持多业务线共享同一平台。

---

## 5. 搜题场景专项设计（首个落地场景）

### 5.1 场景拆分
针对你提到的考试类题型，建议先拆为：
- 图形推理
- 逻辑判断
- 言语理解
- 资料分析
- 定义判断/常识判断

### 5.2 路由策略
- 第一步：快速题型识别（轻量模型或规则 + OCR结构特征）。
- 第二步：按题型路由对应 Workflow。
- 第三步：仅对适合检索题型启用 KB（如定义/常识/资料）。

### 5.3 时延友好策略
- 快速首答：先返回候选答案 + 简短依据。
- 低置信度再补强：触发二次校验/重检索。
- 设置总预算（例：8s），超预算返回当前最优答案并标注置信度。

### 5.4 结果结构（示例字段约束）
- `scenario_id`
- `sub_type`（图推/言语/资料...）
- `answer`
- `evidence`（1-3条）
- `confidence`（0-1）
- `trace_id`
- `latency_ms`
- `model_path`（用于回溯）

---

## 6. Dify 集成方案

### 6.1 使用方式
- 以 Dify Workflow 为主（更适合可控流程、分支和工具调用）。
- Chatflow 作为轻量对话场景补充。

### 6.2 编排范式
标准工作流建议节点：
1. 输入规范化（OCR、清洗、结构提取）
2. 场景/题型确认
3. 检索决策（是否查 KB）
4. 主推理节点
5. 结构化输出校验
6. 低置信度回路（可选）
7. 输出封装

### 6.3 Dify 与平台边界
- Dify 负责流程编排与模型调用。
- DifyModel 平台负责：接入、路由策略、统一协议、治理与观测。

---

## 7. 知识库策略（通用）

### 7.1 知识库分层
- `global_kb`：通用知识（基础规则、通识）。
- `domain_kb`：按业务域（考试、法务、客服）。
- `tenant_kb`：租户私有知识（企业内部文档）。

### 7.2 检索策略
- 多路召回：关键词 + 向量召回。
- 重排：按场景权重和时间新鲜度重排。
- 结果裁剪：限制上下文长度，防止时延暴涨。

### 7.3 版本与治理
- 每次知识库更新产出版本号。
- 在线请求记录命中的 `kb_version`，支持回放与回归评测。

---

## 8. 对外 API 设计（建议）

### 8.1 统一入口
- `POST /v1/infer`
- 输入包含：`scenario_id`, `input`, `context`, `options`。
- 输出统一结构，避免上游适配多个接口。

### 8.2 流式接口
- `GET /v1/infer/stream/:trace_id`
- 用于首答快速返回和状态更新（处理中/补强中/完成）。

### 8.3 控制接口
- `POST /v1/feedback`：用户反馈正确/错误。
- `GET /v1/traces/:trace_id`：审计追踪。
- `POST /v1/eval/run`：触发评测任务。

---

## 9. 数据与存储规划

### 9.1 核心数据对象
- 请求日志（输入摘要、场景、调用链）
- 推理结果（标准化输出 + 原始输出）
- 检索日志（命中片段、得分、版本）
- 反馈数据（人工标注）
- 评测结果（模型/流程版本维度）

### 9.2 数据分级
- 原始敏感输入可脱敏或按策略不落盘。
- 产线默认最小化存储，调试时可短期扩展保留。

---

## 10. 质量体系（重点）

### 10.1 指标
- 准确率：按场景、按子题型拆分统计。
- 时延：P50/P90/P95。
- 稳定性：错误率、超时率、降级率。
- 成本：单请求 token 成本、场景成本。

### 10.2 评测机制
- 建立“固定回归集 + 在线抽样集”。
- 每次 workflow/prompt/kb 变更必须跑回归。
- 通过阈值后才允许灰度。

### 10.3 人工反馈闭环
- 业务端打分（正确/错误/部分正确）。
- 低分样本自动进入复盘池，驱动 prompt 和 KB 修复。

---

## 11. 时延与成本控制策略

### 11.1 时延预算
- 总预算 + 阶段预算（识别、检索、推理、校验）。
- 超预算时触发降级：缩短上下文、跳过次要步骤、返回快速结论。

### 11.2 成本策略
- 场景分级：高价值场景可用高成本模型。
- 低价值或高并发场景优先轻量模型。
- 缓存复用：相似请求可复用历史结果（带有效期）。

---

## 12. 安全与合规

- API Key 与密钥统一托管，不写死代码。
- 请求鉴权：租户级 Token + 签名。
- 权限模型：场景权限、知识库权限、管理台权限。
- 审计日志：管理操作、知识库变更、流程发布均可追踪。

---

## 13. 发布与运维

### 13.1 环境分层
- `dev` / `staging` / `prod` 三环境。
- Dify 流程版本与平台配置版本双版本管理。

### 13.2 灰度策略
- 按租户灰度、按流量比例灰度。
- AB 实验比较准确率与时延，不仅看主观体验。

### 13.3 告警建议
- 错误率、超时率、KB 未命中率、成本异常波动、Dify 上游失败率。

---

## 14. 项目目录建议（DifyModel）

> 不写代码，先规划结构

- `docs/`
  - `ARCHITECTURE.md`
  - `SCENARIOS.md`
  - `API_SPEC.md`
  - `EVAL_PLAN.md`
- `configs/`
  - `scenarios/`（各场景配置）
  - `policies/`（时延/质量/成本策略）
  - `kb-mappings/`（场景到知识库映射）
- `workflows/`
  - `exam_qa/`
  - `doc_qa/`
  - `...`
- `scripts/`
  - 评测、数据清洗、导入导出脚本（后续）
- `ops/`
  - 发布与运维手册

---

## 15. 分阶段实施路线（建议）

### Phase 0：方案冻结（1-2天）
- 定义统一输入输出协议。
- 定义首批场景与 KPI（准确率、P95 时延）。

### Phase 1：最小可用链路（3-5天）
- 打通 Dify Workflow 调用。
- 实现单场景（搜题）端到端。
- 接入基础日志与 trace_id。

### Phase 2：通用化改造（5-7天）
- 场景配置化。
- 知识库映射与策略化路由。
- 结构化输出校验与降级策略。

### Phase 3：质量治理（持续）
- 回归评测体系。
- 反馈闭环。
- 灰度与 AB。

---

## 16. 风险清单与应对

- **风险1：过度依赖 Dify 单点**
  - 应对：保留 Adapter 层，协议不绑定供应商。
- **风险2：追求准确率导致时延失控**
  - 应对：分层策略与硬预算。
- **风险3：知识库噪声反而降准**
  - 应对：分场景启用、版本化、离线评测再上线。
- **风险4：场景扩展后配置失控**
  - 应对：配置模板化 + 变更审计 + 发布流程。

---

## 17. 与现有 InterviewCodeOverlay 对接方式

- 现有客户端/后端无需理解 Dify 细节，只调用 DifyModel 统一 API。
- 先并行接入（老链路保留），通过灰度比较后再切主。
- 保留可回退开关，出现质量波动可秒级回切。

---

## 18. 当前结论

对于你当前目标（搜题提准且保通用扩展），最佳路径是：
1. 先把 DifyModel 当“独立 AI 中台”建设；
2. 用场景配置 + 工作流编排方式落地首场景；
3. 从 Day 1 就纳入时延、准确率、成本三指标治理；
4. 后续新增业务场景时复用同一套平台能力，不再重复造轮子。


---

## 19. 技术栈建议（补充）

### 19.1 服务端（推荐）
- **语言/运行时**：TypeScript + Node.js 20 LTS
- **Web 框架**：Fastify（高性能，插件生态好）
- **校验/契约**：Zod + OpenAPI（自动生成 API 文档）
- **HTTP 客户端**：undici/axios（封装 Dify Connector）
- **流式协议**：SSE（首选）+ WebSocket（可选）

### 19.2 编排与模型层
- **编排引擎**：Dify Workflow（主），Chatflow（辅）
- **模型接入**：通过 Dify 统一管理（保留 Provider Adapter 以便后续替换）
- **OCR/视觉能力**：优先走 Dify 工作流工具节点，必要时外接 OCR 服务

### 19.3 数据与缓存
- **主数据库**：PostgreSQL（元数据、trace、评测结果）
- **缓存/队列**：Redis（幂等、限流计数、短期结果缓存、任务状态）
- **对象存储**：S3 兼容存储（截图、附件、评测样本）
- **检索库**：
  - 初期：直接用 Dify 知识库
  - 中后期（可选）：Milvus/pgvector 做自定义检索增强

### 19.4 可观测与运维
- **日志**：Pino（结构化日志）
- **指标**：Prometheus + Grafana
- **链路追踪**：OpenTelemetry + Jaeger/Tempo
- **错误告警**：Sentry + 飞书/企业微信告警
- **部署**：Docker + Docker Compose（起步），Kubernetes（规模后）

### 19.5 工程化
- **包管理**：pnpm
- **代码规范**：ESLint + Prettier
- **测试**：Vitest/Jest + Supertest（接口回归）
- **CI/CD**：GitHub Actions（lint/test/build/eval gate）
- **配置管理**：`.env` + 分环境配置文件（dev/staging/prod）

### 19.6 前后端管理台（如果要做）
- **前端**：React + Vite + TypeScript + TanStack Query
- **UI**：Ant Design 或 shadcn/ui（二选一统一）
- **权限**：RBAC（场景、知识库、发布权限）

### 19.7 为什么这套栈适合你当前阶段
- 与你现有项目生态（Node/TS）一致，迁移成本低。
- 支持从单机场景快速起步，再平滑升级到多场景、多租户。
- 对“准确率、时延、成本”治理需要的观测与评测能力完整。

